name: Build and Publish CWR Artifacts
on:
  push:
    branches: [main]
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:

permissions:
  packages: write
  contents: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      core-libs: ${{ steps.filter.outputs.core-libs }}
      cli: ${{ steps.filter.outputs.cli }}
      water-charts: ${{ steps.filter.outputs.water-charts }}
      snow-charts: ${{ steps.filter.outputs.snow-charts }}
      fixtures: ${{ steps.filter.outputs.fixtures }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        if: github.event_name == 'push'
        with:
          filters: |
            core-libs:
              - 'cwr-cdec/**'
              - 'cwr-db/**'
              - 'cwr-data/**'
              - 'cwr-utils/**'
              - 'cwr-chart-ui/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
            cli:
              - 'cwr-cmd/**'
              - 'cwr-cli/**'
            water-charts:
              - 'chart-total-water/**'
              - 'chart-water-years/**'
              - 'chart-reservoir-history/**'
              - 'chart-cumulative-water/**'
              - 'chart-local-reservoirs/**'
              - 'table-water-year-stats/**'
            snow-charts:
              - 'chart-total-snow/**'
              - 'chart-snow-years/**'
              - 'chart-snow-history/**'
              - 'table-snow-stats/**'
            fixtures:
              - 'fixtures/**'

  test:
    needs: detect-changes
    if: needs.detect-changes.outputs.core-libs == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/afbase/rust-zola-builder:pinned
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
      - name: Run tests
        run: cargo test --package cwr-cdec --package cwr-db --package cwr-data --package cwr-utils --package cwr-cmd

  build-cli-image:
    needs: detect-changes
    if: needs.detect-changes.outputs.cli == 'true' || needs.detect-changes.outputs.fixtures == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v6
        with:
          context: .
          file: docker-images/cwr-cli/Dockerfile
          push: true
          tags: ghcr.io/afbase/cwr-cli:latest

  fetch-water-data:
    needs: [detect-changes, build-cli-image]
    if: always() && (needs.detect-changes.outputs.cli == 'true' || needs.detect-changes.outputs.fixtures == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/afbase/cwr-cli:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: fixtures
      - name: Cache water fixtures
        uses: actions/cache@v4
        with:
          path: fixtures/observations.csv
          key: cwr-water-fixtures-${{ github.run_number }}
          restore-keys: cwr-water-fixtures-
      - name: Fetch water data (incremental)
        run: |
          set -euxo pipefail
          MAX_RETRIES=5
          RETRY_DELAY=5
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $attempt of $MAX_RETRIES"
            if cwr-cli incremental-query -r fixtures/observations.csv; then
              echo "Water queries completed successfully"
              break
            fi
            if [ $attempt -lt $MAX_RETRIES ]; then
              echo "Retrying in $RETRY_DELAY seconds..."
              sleep $RETRY_DELAY
            else
              echo "Failed after $MAX_RETRIES attempts"
              exit 1
            fi
          done
      - name: Validate water data
        run: |
          if [ -f fixtures/observations.csv ]; then
            lines=$(wc -l < fixtures/observations.csv)
            echo "fixtures/observations.csv: $lines lines"
          else
            echo "WARNING: fixtures/observations.csv does not exist"
          fi
      - uses: actions/upload-artifact@v4
        with:
          name: cwr-water-fixtures
          path: |
            fixtures/observations.csv
            fixtures/capacity.csv

  fetch-snow-data:
    needs: [detect-changes, build-cli-image]
    if: always() && (needs.detect-changes.outputs.cli == 'true' || needs.detect-changes.outputs.fixtures == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/afbase/cwr-cli:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: fixtures
      - name: Cache snow fixtures
        uses: actions/cache@v4
        with:
          path: |
            fixtures/snow_stations.csv
            fixtures/snow_observations.csv
          key: cwr-snow-fixtures-${{ github.run_number }}
          restore-keys: cwr-snow-fixtures-
      - name: Fetch snow data (incremental)
        run: |
          set -euxo pipefail
          cwr-cli snow-query -t fixtures/snow_observations.csv || echo "Snow query failed (non-fatal)"
      - name: Validate snow data
        run: |
          if [ -f fixtures/snow_observations.csv ]; then
            lines=$(wc -l < fixtures/snow_observations.csv)
            echo "fixtures/snow_observations.csv: $lines lines"
          else
            echo "WARNING: fixtures/snow_observations.csv does not exist"
          fi
      - uses: actions/upload-artifact@v4
        with:
          name: cwr-snow-fixtures
          path: |
            fixtures/snow_stations.csv
            fixtures/snow_observations.csv

  build-water-wasm:
    needs: [detect-changes, fetch-water-data]
    if: always() && (needs.detect-changes.outputs.core-libs == 'true' || needs.detect-changes.outputs.water-charts == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/afbase/rust-zola-builder:pinned
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
      - name: Download fixtures
        uses: actions/download-artifact@v4
        with:
          name: cwr-water-fixtures
          path: fixtures/
        continue-on-error: true
      - name: Cache fixture data
        uses: actions/cache@v4
        with:
          path: |
            fixtures/observations.csv
            fixtures/capacity.csv
          key: cwr-water-fixtures-${{ github.run_number }}
          restore-keys: |
            cwr-water-fixtures-
      - name: Install Dioxus CLI
        run: cargo install dioxus-cli --locked || true
      - name: Build and collect water WASM apps
        run: |
          set -euxo pipefail
          mkdir -p dist
          BUILD_SUCCESS=()
          BUILD_FAILED=()

          for app in chart-total-water chart-water-years chart-reservoir-history table-water-year-stats chart-local-reservoirs chart-cumulative-water; do
            echo "============================================"
            echo "Building WASM for ${app}"
            echo "============================================"
            cd "${app}"

            if dx build --release --platform web; then
              cd ..
              public_dir="target/dx/${app}/release/web/public"
              if [ -d "$public_dir" ]; then
                # Verify that both JS and WASM files were generated
                js_count=$(find "$public_dir" -name "*.js" -not -name "*_bg*" | wc -l)
                wasm_count=$(find "$public_dir" -name "*_bg*.wasm" | wc -l)

                if [ "$js_count" -gt 0 ] && [ "$wasm_count" -gt 0 ]; then
                  mkdir -p "dist/${app}"
                  cp -r "$public_dir"/* "dist/${app}/" 2>/dev/null || true
                  rm -f "dist/${app}/index.html"
                  echo "✓ Successfully collected ${app}:"
                  find "dist/${app}" -type f | sort | sed 's/^/  /'
                  BUILD_SUCCESS+=("${app}")
                else
                  echo "✗ Build completed but missing files: JS=${js_count}, WASM=${wasm_count}"
                  BUILD_FAILED+=("${app}")
                fi
              else
                echo "✗ Build succeeded but no public output directory: ${public_dir}"
                BUILD_FAILED+=("${app}")
              fi
            else
              cd ..
              echo "✗ Build command failed for ${app}"
              BUILD_FAILED+=("${app}")
            fi
          done

          echo ""
          echo "============================================"
          echo "Build Summary"
          echo "============================================"
          echo "Successful builds (${#BUILD_SUCCESS[@]}): ${BUILD_SUCCESS[*]}"
          echo "Failed builds (${#BUILD_FAILED[@]}): ${BUILD_FAILED[*]}"
          echo ""
          echo "=== Final dist contents ==="
          find dist -type f | sort

          # Fail workflow if ALL builds failed
          if [ ${#BUILD_SUCCESS[@]} -eq 0 ]; then
            echo "ERROR: All builds failed"
            exit 1
          fi
      - name: Upload water artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cwr-water-dist
          path: dist/

  build-snow-wasm:
    needs: [detect-changes, fetch-snow-data]
    if: always() && (needs.detect-changes.outputs.core-libs == 'true' || needs.detect-changes.outputs.snow-charts == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/afbase/rust-zola-builder:pinned
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
      - name: Download fixtures
        uses: actions/download-artifact@v4
        with:
          name: cwr-snow-fixtures
          path: fixtures/
        continue-on-error: true
      - name: Cache fixture data
        uses: actions/cache@v4
        with:
          path: |
            fixtures/snow_stations.csv
            fixtures/snow_observations.csv
          key: cwr-snow-fixtures-${{ github.run_number }}
          restore-keys: |
            cwr-snow-fixtures-
      - name: Install Dioxus CLI
        run: cargo install dioxus-cli --locked || true
      - name: Build and collect snow WASM apps
        run: |
          set -euxo pipefail
          mkdir -p dist
          BUILD_SUCCESS=()
          BUILD_FAILED=()

          for app in chart-total-snow chart-snow-years chart-snow-history table-snow-stats; do
            echo "============================================"
            echo "Building WASM for ${app}"
            echo "============================================"
            cd "${app}"

            if dx build --release --platform web; then
              cd ..
              public_dir="target/dx/${app}/release/web/public"
              if [ -d "$public_dir" ]; then
                # Verify that both JS and WASM files were generated
                js_count=$(find "$public_dir" -name "*.js" -not -name "*_bg*" | wc -l)
                wasm_count=$(find "$public_dir" -name "*_bg*.wasm" | wc -l)

                if [ "$js_count" -gt 0 ] && [ "$wasm_count" -gt 0 ]; then
                  mkdir -p "dist/${app}"
                  cp -r "$public_dir"/* "dist/${app}/" 2>/dev/null || true
                  rm -f "dist/${app}/index.html"
                  echo "✓ Successfully collected ${app}:"
                  find "dist/${app}" -type f | sort | sed 's/^/  /'
                  BUILD_SUCCESS+=("${app}")
                else
                  echo "✗ Build completed but missing files: JS=${js_count}, WASM=${wasm_count}"
                  BUILD_FAILED+=("${app}")
                fi
              else
                echo "✗ Build succeeded but no public output directory: ${public_dir}"
                BUILD_FAILED+=("${app}")
              fi
            else
              cd ..
              echo "✗ Build command failed for ${app}"
              BUILD_FAILED+=("${app}")
            fi
          done

          echo ""
          echo "============================================"
          echo "Build Summary"
          echo "============================================"
          echo "Successful builds (${#BUILD_SUCCESS[@]}): ${BUILD_SUCCESS[*]}"
          echo "Failed builds (${#BUILD_FAILED[@]}): ${BUILD_FAILED[*]}"
          echo ""
          echo "=== Final dist contents ==="
          find dist -type f | sort

          # Fail workflow if ALL builds failed
          if [ ${#BUILD_SUCCESS[@]} -eq 0 ]; then
            echo "ERROR: All builds failed"
            exit 1
          fi
      - name: Upload snow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cwr-snow-dist
          path: dist/

  publish:
    needs: [build-water-wasm, build-snow-wasm]
    if: always() && (needs.build-water-wasm.result == 'success' || needs.build-snow-wasm.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download water artifacts
        uses: actions/download-artifact@v4
        with:
          name: cwr-water-dist
          path: dist/
        continue-on-error: true
      - name: Download snow artifacts
        uses: actions/download-artifact@v4
        with:
          name: cwr-snow-dist
          path: dist/
        continue-on-error: true
      - name: Download water fixture artifacts
        uses: actions/download-artifact@v4
        with:
          name: cwr-water-fixtures
          path: dist/fixtures/
        continue-on-error: true
      - name: Download snow fixture artifacts
        uses: actions/download-artifact@v4
        with:
          name: cwr-snow-fixtures
          path: dist/fixtures/
        continue-on-error: true
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push artifact image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: .github/Dockerfile.artifact
          push: true
          tags: ghcr.io/afbase/california-water-reservoir-tk:latest
      - name: Trigger afbase.github.io rebuild
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.CROSS_REPO_TOKEN }}
          repository: afbase/afbase.github.io
          event-type: cwr-updated
